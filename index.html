<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>文樞</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;400;500;600&family=Noto+Sans+TC:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
--primary-color: #7fb3d5;
--secondary-color: #a2d9ce;
--accent-color: #a9cce3;
--highlight-color: #7dcea0;
--soft-color: #76d7c4;
--light-accent: #aed6f1;
--background-color: #f8fafa;
--text-color: #2c3e50;
--light-color: #ffffff;
--dark-color: #34495e;
--error-color: #e74c3c;
--hidden-bg: #ecf0f1;
--shadow-light: 0 2px 12px rgba(127, 179, 213, 0.15);
--shadow-medium: 0 4px 24px rgba(127, 179, 213, 0.2);
--shadow-heavy: 0 8px 36px rgba(127, 179, 213, 0.25);
--gradient-primary: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
--gradient-accent: linear-gradient(135deg, var(--highlight-color), var(--soft-color));
--border-radius: 12px;
--border-radius-small: 6px;
--transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

* {
box-sizing: border-box;
margin: 0;
padding: 0;
}

body {
font-family: 'Noto Sans TC', 'Microsoft JhengHei', sans-serif;
background: linear-gradient(to bottom right, #f8fafa 0%, #f0f8ff 100%);
color: var(--text-color);
line-height: 1.6;
padding: 20px;
min-height: 100vh;
}

.container {
max-width: 1400px;
margin: 0 auto;
padding: 20px;
display: grid;
grid-template-columns: 1fr 2fr;
gap: 30px;
}

.copyright-footer {
position: fixed;
bottom: 0;
right: 0;
padding: 5px 10px;
background-color: #f1f1f1;
}

.copyright-footer p {
margin: 0;
font-size: 14px;
}

/* 平板版面 (768px - 1024px) - 與電腦版相同 */
@media (max-width: 1024px) and (min-width: 768px) {
.container {
grid-template-columns: 1fr 2fr;
width: 95%;
margin: 0 auto;
}

.input-section {
position: sticky;
top: 20px;
height: fit-content;
}
}

/* 手機版面 (小於768px) - 原文在上方1/3位置 */
@media (max-width: 767px) {
body {
padding: 10px;
}

.container {
grid-template-columns: 1fr;
gap: 15px;
width: 100%;
margin: 0 auto;
padding: 10px;
}

.input-section {
position: fixed;
top: 0;
left: 0;
right: 0;
height: 33vh;
z-index: 1000;
margin: 0;
border-radius: 0 0 var(--border-radius) var(--border-radius);
overflow-y: auto;
padding: 15px;
}

.output-section {
margin-top: 35vh;
grid-column: 1;
}

.copyright-footer p {
font-size: 12px;
}
}

/* 電腦版面 (大於1024px) - 原有設計 */
@media (min-width: 1025px) {
.container {
grid-template-columns: 1fr 2fr;
}

.input-section {
position: sticky;
top: 20px;
height: fit-content;
}
}

header {
text-align: center;
margin-bottom: 40px;
padding: 40px 20px;
background: var(--gradient-primary);
color: var(--light-color);
border-radius: var(--border-radius);
box-shadow: var(--shadow-medium);
position: relative;
overflow: hidden;
grid-column: 1 / -1;
}

@media (max-width: 767px) {
header {
margin-bottom: 20px;
padding: 20px 10px;
position: relative;
z-index: 999;
}
}

header::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="80" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="60" cy="30" r="1" fill="rgba(255,255,255,0.1)"/></svg>');
pointer-events: none;
}

h1 {
margin-bottom: 15px;
font-size: clamp(2rem, 4vw, 3rem);
font-weight: 300;
letter-spacing: 3px;
font-family: 'Noto Serif TC', serif;
position: relative;
z-index: 1;
}

.input-section {
background: var(--light-color);
border-radius: var(--border-radius);
box-shadow: var(--shadow-light);
padding: 30px;
border: 2px solid rgba(127, 179, 213, 0.1);
transition: var(--transition);
position: relative;
overflow: hidden;
grid-column: 1;
}

@media (max-width: 767px) {
.input-section {
padding: 15px;
}
}

.input-section::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
height: 4px;
background: var(--gradient-primary);
}

.input-section:hover {
box-shadow: var(--shadow-medium);
transform: translateY(-2px);
}

@media (max-width: 767px) {
.input-section:hover {
transform: none;
}
}

.section-title {
color: var(--primary-color);
margin-bottom: 25px;
padding-bottom: 15px;
border-bottom: 2px solid var(--light-accent);
font-size: 1.4rem;
font-weight: 500;
font-family: 'Noto Serif TC', serif;
display: flex;
align-items: center;
gap: 10px;
}

@media (max-width: 767px) {
.section-title {
font-size: 1.2rem;
margin-bottom: 15px;
padding-bottom: 10px;
}
}

.section-title::before {
content: '';
width: 8px;
height: 8px;
background: var(--secondary-color);
border-radius: 50%;
}

textarea {
width: 100%;
min-height: 400px;
padding: 20px;
border: 2px solid var(--light-accent);
border-radius: var(--border-radius-small);
resize: vertical;
font-size: 18px;
line-height: 1.8;
transition: var(--transition);
background: linear-gradient(to bottom, #fafafa, #ffffff);
font-family: 'Noto Serif TC', serif;
}

@media (max-width: 767px) {
textarea {
min-height: 120px;
padding: 15px;
font-size: 16px;
}
}

textarea:focus {
outline: none;
border-color: var(--primary-color);
background: var(--light-color);
box-shadow: 0 0 0 4px rgba(127, 179, 213, 0.1);
}

.button-group {
display: flex;
gap: 15px;
margin-top: 25px;
flex-wrap: wrap;
}

@media (max-width: 767px) {
.button-group {
gap: 10px;
margin-top: 15px;
}
}

button {
padding: 14px 28px;
background: var(--gradient-primary);
color: var(--light-color);
border: none;
border-radius: var(--border-radius-small);
cursor: pointer;
font-size: 16px;
font-weight: 500;
transition: var(--transition);
flex: 1;
min-width: 130px;
box-shadow: var(--shadow-light);
position: relative;
overflow: hidden;
}

@media (max-width: 767px) {
button {
padding: 12px 20px;
font-size: 14px;
min-width: 100px;
}
}

button::before {
content: '';
position: absolute;
top: 0;
left: -100%;
width: 100%;
height: 100%;
background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
transition: left 0.5s;
}

button:hover::before {
left: 100%;
}

button:hover {
transform: translateY(-3px);
box-shadow: var(--shadow-medium);
}

@media (max-width: 767px) {
button:hover {
transform: translateY(-1px);
}
}

button:active {
transform: translateY(-1px);
}

button:disabled {
background: #bdc3c7;
cursor: not-allowed;
transform: none;
box-shadow: none;
}

.clear-btn {
background: linear-gradient(135deg, #e74c3c, #c0392b);
}

.reveal-all-btn {
background: linear-gradient(135deg, #f39c12, #e67e22);
margin-top: 20px;
width: 100%;
}

.output-section {
background: var(--light-color);
border-radius: var(--border-radius);
box-shadow: var(--shadow-light);
padding: 30px;
border: 2px solid rgba(127, 179, 213, 0.1);
transition: var(--transition);
position: relative;
overflow: hidden;
grid-column: 2;
}

@media (max-width: 1024px) {
.output-section {
grid-column: 1;
}
}

@media (max-width: 767px) {
.output-section {
padding: 20px;
}
}

.output-section::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
height: 4px;
background: var(--gradient-primary);
}

.output-section:hover {
box-shadow: var(--shadow-medium);
transform: translateY(-2px);
}

@media (max-width: 767px) {
.output-section:hover {
transform: none;
}
}

.output-content {
min-height: 200px;
padding: 25px;
border: 2px solid var(--light-accent);
border-radius: var(--border-radius-small);
background: linear-gradient(to bottom, #fafafa, #ffffff);
}

@media (max-width: 767px) {
.output-content {
padding: 15px;
}
}

.loading {
display: none;
text-align: center;
padding: 50px;
color: var(--primary-color);
}

@media (max-width: 767px) {
.loading {
padding: 30px;
}
}

.spinner {
border: 4px solid rgba(127, 179, 213, 0.2);
border-radius: 50%;
border-top: 4px solid var(--primary-color);
width: 50px;
height: 50px;
animation: spin 1s linear infinite;
margin: 0 auto 20px;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

.error-message {
color: var(--error-color);
margin-top: 20px;
display: none;
padding: 15px;
background: #fadbd8;
border: 2px solid #f1948a;
border-radius: var(--border-radius-small);
}

@media (max-width: 767px) {
.error-message {
margin-top: 10px;
padding: 10px;
font-size: 14px;
}
}

.translation-block {
margin-bottom: 35px;
border-bottom: 2px dashed var(--light-accent);
padding-bottom: 25px;
}

.translation-block:last-child {
border-bottom: none;
}

.original-title, .translation-title {
font-weight: 600;
color: var(--primary-color);
margin-bottom: 15px;
font-size: 1.3rem;
font-family: 'Noto Serif TC', serif;
}

@media (max-width: 767px) {
.original-title, .translation-title {
font-size: 1.1rem;
margin-bottom: 10px;
}
}

.original-text {
font-size: 18px;
line-height: 2;
margin-bottom: 25px;
padding: 20px;
background: linear-gradient(135deg, var(--light-accent), rgba(173, 214, 241, 0.3));
border-left: 5px solid var(--primary-color);
border-radius: var(--border-radius-small);
font-family: 'Noto Serif TC', serif;
}

@media (max-width: 767px) {
.original-text {
font-size: 16px;
line-height: 1.8;
margin-bottom: 15px;
padding: 15px;
}
}

.translation-text {
background: linear-gradient(135deg, rgba(162, 217, 206, 0.2), rgba(118, 215, 196, 0.1));
padding: 20px;
border-radius: var(--border-radius-small);
line-height: 1.8;
font-size: 16px;
border-left: 5px solid var(--secondary-color);
}

@media (max-width: 767px) {
.translation-text {
padding: 15px;
font-size: 14px;
}
}

.character-breakdown {
margin-top: 20px;
padding: 20px;
background: linear-gradient(135deg, rgba(169, 204, 227, 0.2), rgba(125, 206, 160, 0.1));
border-radius: var(--border-radius-small);
font-size: 15px;
border-left: 5px solid var(--highlight-color);
}

@media (max-width: 767px) {
.character-breakdown {
margin-top: 15px;
padding: 15px;
font-size: 14px;
}
}

.character-item {
margin-bottom: 12px;
display: flex;
align-items: flex-start;
padding: 8px 0;
border-bottom: 1px solid rgba(127, 179, 213, 0.1);
}

.character-item:last-child {
border-bottom: none;
}

.word-with-explanation {
position: relative;
display: inline;
color: var(--primary-color);
font-weight: 600;
cursor: pointer;
border-bottom: 2px dotted var(--primary-color);
margin: 0 2px;
padding: 2px 4px;
border-radius: 3px;
transition: var(--transition);
}

.word-with-explanation:hover {
background: rgba(127, 179, 213, 0.1);
}

.explanation-icon {
color: var(--secondary-color);
font-size: 0.9em;
margin-left: 4px;
cursor: pointer;
opacity: 0.8;
transition: var(--transition);
padding: 2px;
border-radius: 50%;
}

.explanation-icon:hover {
opacity: 1;
background: rgba(162, 217, 206, 0.3);
transform: scale(1.1);
}

.word-explanation {
display: none;
position: absolute;
bottom: 120%;
left: 50%;
transform: translateX(-50%);
background: var(--dark-color);
color: var(--light-color);
padding: 12px 16px;
border-radius: var(--border-radius-small);
font-size: 14px;
white-space: nowrap;
z-index: 1001;
box-shadow: var(--shadow-medium);
max-width: 300px;
white-space: normal;
}

@media (max-width: 767px) {
.word-explanation {
font-size: 12px;
padding: 8px 12px;
max-width: 200px;
}
}

.word-explanation::after {
content: '';
position: absolute;
top: 100%;
left: 50%;
transform: translateX(-50%);
border: 6px solid transparent;
border-top-color: var(--dark-color);
}

.word-explanation.show {
display: block;
animation: fadeInUp 0.3s ease-out;
}

@keyframes fadeInUp {
from {
opacity: 0;
transform: translateX(-50%) translateY(10px);
}
to {
opacity: 1;
transform: translateX(-50%) translateY(0);
}
}

.click-to-reveal {
position: relative;
cursor: pointer;
margin: 0 2px;
display: inline-block;
transition: var(--transition);
}

.hidden-text {
background: var(--hidden-bg);
color: transparent;
border-radius: 4px;
padding: 4px 8px;
transition: var(--transition);
user-select: none;
position: relative;
}

.hidden-text::before {
content: '點擊顯示';
position: absolute;
top: 50%;
left: 50%;
transform: translate(-50%, -50%);
color: var(--primary-color);
font-size: 12px;
opacity: 0.7;
pointer-events: none;
}

.hidden-text:hover {
background: rgba(127, 179, 213, 0.2);
}

.hidden-text.revealed {
background: transparent;
color: inherit;
}

.hidden-text.revealed::before {
display: none;
}

.sentence-container {
margin-bottom: 15px;
}

.character {
color: var(--primary-color);
font-weight: 600;
cursor: pointer;
border-bottom: 2px dotted var(--primary-color);
padding: 2px 4px;
border-radius: 3px;
transition: var(--transition);
}

.character:hover {
background: rgba(127, 179, 213, 0.1);
}

.explanation {
display: none;
padding-left: 20px;
color: var(--dark-color);
font-style: italic;
margin-top: 8px;
border-left: 3px solid var(--secondary-color);
padding: 8px 0 8px 15px;
}

.explanation.revealed {
display: block;
animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
from {
opacity: 0;
max-height: 0;
}
to {
opacity: 1;
max-height: 100px;
}
}

.common-word {
background: linear-gradient(135deg, rgba(127, 179, 213, 0.2), rgba(162, 217, 206, 0.2));
padding: 2px 6px;
border-radius: 4px;
font-weight: 600;
}

::-webkit-scrollbar {
width: 10px;
}

::-webkit-scrollbar-track {
background: rgba(127, 179, 213, 0.1);
border-radius: 5px;
}

::-webkit-scrollbar-thumb {
background: var(--primary-color);
border-radius: 5px;
}

::-webkit-scrollbar-thumb:hover {
background: var(--secondary-color);
}
</style>

<script type="text/javascript">
var gk_isXlsx = false;
var gk_xlsxFileLookup = {};
var gk_fileData = {};
function filledCell(cell) {
  return cell !== '' && cell != null;
}
function loadFileData(filename) {
if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
    try {
        var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
        var firstSheetName = workbook.SheetNames[0];
        var worksheet = workbook.Sheets[firstSheetName];

        var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
        var filteredData = jsonData.filter(row => row.some(filledCell));

        var headerRowIndex = filteredData.findIndex((row, index) =>
          row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
        );
        if (headerRowIndex === -1 || headerRowIndex > 25) {
          headerRowIndex = 0;
        }

        var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex));
        csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
        return csv;
    } catch (e) {
        console.error(e);
        return "";
    }
}
return gk_fileData[filename] || "";
}
</script>
</head>
<body>
<div class="container">
<header>
<h1>文樞</h1>
</header>

<div class="input-section">
<h2 class="section-title">輸入文言文</h2>
<textarea id="classical-text" placeholder="請在此輸入文言文篇章內容..."></textarea>
<div class="button-group">
<button id="translate-btn">
<i class="fas fa-language"></i> 翻譯
</button>
<button id="clear-btn" class="clear-btn">
<i class="fas fa-eraser"></i> 清除
</button>
</div>
<div class="error-message" id="error-message"></div>
</div>

<div class="output-section">
<h2 class="section-title">翻譯結果</h2>
<div class="loading" id="loading">
<div class="spinner"></div>
<p>正在翻譯中，請稍候...</p>
</div>
<div class="output-content" id="translation-result"></div>
<button id="reveal-all-btn" class="reveal-all-btn">
<i class="fas fa-eye"></i> 顯示全部解釋
</button>
</div>

<footer class="copyright-footer">
<p>Copyright © 2025 黃子謙、陳冠健. All rights reserved</p>
</footer>
</div>

<script>
const API_KEYS = [
"sk-MoqwsgO8P9MEoCrftvdSYA"
];
let currentApiKeyIndex = 0;
const API_URL = "https://chatapi.akash.network/api/v1/chat/completions";
const MODEL = "DeepSeek-R1-0528";

document.addEventListener('DOMContentLoaded', function() {
const translateBtn = document.getElementById('translate-btn');
const clearBtn = document.getElementById('clear-btn');
const revealAllBtn = document.getElementById('reveal-all-btn');
const classicalText = document.getElementById('classical-text');
const translationResult = document.getElementById('translation-result');
const loading = document.getElementById('loading');
const errorMessage = document.getElementById('error-message');

translateBtn.addEventListener('click', function() {
const text = classicalText.value.trim();

if (!text) {
showError('請輸入文言文內容');
return;
}

translateText(text);
});

clearBtn.addEventListener('click', function() {
classicalText.value = '';
translationResult.innerHTML = '';
hideError();
});

revealAllBtn.addEventListener('click', function() {
const hiddenElements = document.querySelectorAll('.hidden-text');
hiddenElements.forEach(el => {
el.classList.add('revealed');
});

const explanations = document.querySelectorAll('.explanation');
explanations.forEach(el => {
el.classList.add('revealed');
});
});

function showError(message) {
errorMessage.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
errorMessage.style.display = 'block';
}

function hideError() {
errorMessage.style.display = 'none';
}

async function translateText(text) {
try {
loading.style.display = 'block';
translationResult.innerHTML = '';
hideError();

translateBtn.disabled = true;

const prompt = `請將以下文言文逐字翻譯並解釋(直譯，不要意譯)，格式要求：

原文：
[顯示原文句子]

語譯：
[顯示完整句子翻譯]

逐字解釋：
[對每個文字字符進行解釋，格式為"字：解釋"，常見文言字詞用**粗體**標示，不要解釋標點符號]

要求：
1. 為每一句(以，。？!：； 作為分隔)進行語譯
2. 如果該行有常見文言字詞，請為該字及其詞解粗體
3. 用中文繁體字顯示所有內容
4. 不要提供思考過程，用<think></think>中間內容
5. 保持嚴格的格式，使用標題和清晰的分段
6. 不要在任何地方使用多餘的星號(*)
7. 不要使用任何裝飾性符號或分隔線
8. 確保每部分都有明確的標題（原文、語譯、逐字解釋）
9. 逐字解釋只解釋文字字符，不解釋標點符號如，。？!等

需要翻譯的文言文：
${text}`;

const response = await callTranslateAPI(prompt);

if (response && response.choices && response.choices[0].message.content) {
const translatedText = response.choices[0].message.content;
displayFormattedResult(translatedText);
} else {
showError('翻譯失敗，請稍後再試');
}
} catch (error) {
console.error('翻譯錯誤:', error);
showError('翻譯過程中發生錯誤: ' + error.message);
} finally {
loading.style.display = 'none';
translateBtn.disabled = false;
}
}

async function callTranslateAPI(prompt) {
const apiKey = API_KEYS[currentApiKeyIndex];

try {
const response = await fetch(API_URL, {
method: 'POST',
headers: {
'Content-Type': 'application/json',
'Authorization': `Bearer ${apiKey}`
},
body: JSON.stringify({
model: MODEL,
messages: [
{
role: "user",
content: prompt
}
],
temperature: 0.3,
max_tokens: 64000
})
});

if (!response.ok) {
throw new Error(`API 請求失敗: ${response.status}`);
}

return await response.json();
} catch (error) {
console.error('API 調用錯誤:', error);
currentApiKeyIndex = (currentApiKeyIndex + 1) % API_KEYS.length;
if (currentApiKeyIndex === 0) {
throw new Error('所有API密鑰嘗試失敗');
}
return callTranslateAPI(prompt);
}
}

function displayFormattedResult(text) {
text = text.replace(/<think>.*?<\/think>/gs, '');

text = cleanTextFormatting(text);

const blocks = splitTranslationBlocks(text);
let htmlOutput = '';

for (let i = 0; i < blocks.length; i++) {
const block = blocks[i];

if (block.type === 'original') {
htmlOutput += `<div class="translation-block">
<div class="original-title"><i class="fas fa-scroll"></i> 原文</div>
<div class="original-text">${formatOriginalText(block.content)}</div>`;
} 
else if (block.type === 'translation') {
htmlOutput += `<div class="translation-title"><i class="fas fa-language"></i> 語譯</div>
<div class="translation-text">${formatTranslationText(block.content)}</div>`;
}
else if (block.type === 'breakdown') {
htmlOutput += `<div class="character-breakdown"><strong><i class="fas fa-search"></i> 逐字解釋</strong>${formatCharacterBreakdown(block.content)}</div>
</div>`;
}
}

translationResult.innerHTML = htmlOutput;
setupClickToReveal();
setupWordExplanations();
}

function setupWordExplanations() {
const commonWords = document.querySelectorAll('.common-word');
commonWords.forEach(word => {
const text = word.textContent.trim();
if (text.length === 1 && /[\u4e00-\u9fff]/.test(text)) {
word.classList.add('word-with-explanation');

const explanation = document.createElement('span');
explanation.className = 'word-explanation';
explanation.textContent = `常見`;
word.appendChild(explanation);

word.addEventListener('click', function() {
const explanationSpan = this.querySelector('.word-explanation');
if (explanationSpan) {
explanationSpan.classList.toggle('show');
commonWords.forEach(otherWord => {
if (otherWord !== this) {
const otherExplanation = otherWord.querySelector('.word-explanation');
if (otherExplanation) {
otherExplanation.classList.remove('show');
}
}
});
}
});
}
});

document.addEventListener('click', function(e) {
if (!e.target.closest('.word-with-explanation')) {
const explanations = document.querySelectorAll('.word-explanation');
explanations.forEach(explanation => {
explanation.classList.remove('show');
});
}
});
}

function setupClickToReveal() {
const characters = document.querySelectorAll('.character');
characters.forEach(character => {
character.addEventListener('click', function() {
const explanation = this.nextElementSibling;
if (explanation && explanation.classList.contains('explanation')) {
explanation.classList.toggle('revealed');
}
});
});

const translationTexts = document.querySelectorAll('.translation-text');
translationTexts.forEach(textDiv => {
const sentences = textDiv.innerHTML.split('<br>').filter(s => s.trim());
let newContent = '';

sentences.forEach(sentence => {
if (sentence.trim()) {
newContent += `
<div class="sentence-container">
<span class="hidden-text click-to-reveal">${sentence.trim()}</span>
</div>
`;
}
});

textDiv.innerHTML = newContent;

const hiddenSentences = textDiv.querySelectorAll('.hidden-text');
hiddenSentences.forEach(sentence => {
sentence.addEventListener('click', function() {
this.classList.toggle('revealed');
});
});
});
}

function splitTranslationBlocks(text) {
const blocks = [];
const lines = text.split('\n');
let currentBlock = null;

for (let i = 0; i < lines.length; i++) {
const line = lines[i].trim();

if (line.startsWith('原文：') || line === '原文') {
if (currentBlock) blocks.push(currentBlock);
currentBlock = { type: 'original', content: '' };
const content = line.replace(/^原文：?\s*/, '');
if (content) currentBlock.content += content + '\n';
}
else if (line.startsWith('語譯：') || line === '語譯') {
if (currentBlock) blocks.push(currentBlock);
currentBlock = { type: 'translation', content: '' };
const content = line.replace(/^語譯：?\s*/, '');
if (content) currentBlock.content += content + '\n';
}
else if (line.startsWith('逐字解釋：') || line === '逐字解釋') {
if (currentBlock) blocks.push(currentBlock);
currentBlock = { type: 'breakdown', content: '' };
const content = line.replace(/^逐字解釋：?\s*/, '');
if (content) currentBlock.content += content + '\n';
}
else if (currentBlock) {
currentBlock.content += line + '\n';
}
}

if (currentBlock) blocks.push(currentBlock);
return blocks;
}

function cleanTextFormatting(text) {
text = text.replace(/^\*+\s*$/gm, '');
text = text.replace(/^\*+/, '').replace(/\*+$/, '');
text = text.replace(/\n{3,}/g, '\n\n');
text = text.replace(/^-{3,}\s*$/gm, '');
return text.trim();
}

function formatOriginalText(text) {
text = cleanSectionText(text);
return text.replace(/\n/g, '<br>')
.replace(/\*\*(.*?)\*\*/g, '<span class="common-word">$1</span>');
}

function formatTranslationText(text) {
text = cleanSectionText(text);
return text.replace(/\n/g, '<br>')
.replace(/\*\*(.*?)\*\*/g, '<span class="common-word">$1</span>');
}

function formatCharacterBreakdown(text) {
text = cleanSectionText(text);

text = text.replace(/\*\*(.*?)\*\*/g, '<span class="common-word">$1</span>');

const lines = text.split('\n').filter(line => line.trim());
let html = '';

lines.forEach(line => {
line = line.replace(/^\*+/, '').replace(/\*+$/, '').trim();

const parts = line.split(/:|：/);
if (parts.length >= 2) {
const character = parts[0].trim();
const explanation = parts.slice(1).join(':').trim();
if (/[\u4e00-\u9fff]/.test(character)) {
html += `
<div class="character-item">
<span class="character">${character}</span>
<span class="explanation">：${explanation}</span>
</div>
`;
}
} else if (line.trim()) {
html += `<div>${line}</div>`;
}
});

return html;
}

function cleanSectionText(text) {
text = text.trim();
text = text.replace(/^：+/, '').replace(/：+$/, '');
text = text.replace(/^\*+/, '').replace(/\*+$/, '');
return text;
}
});
</script>
</body>
</html>
